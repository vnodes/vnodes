generator client {
  provider               = "prisma-client"
  output                 = "../src/app/prisma"
  importFileExtension    = "js"
  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  runtime                = "nodejs"
}

generator nestjs {
  provider = "nestjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  username String @unique /// @format(email)
  password String /// @hash() @format(password)

  firstName  String
  lastName   String
  middleName String?

  userRoles UserRole[] /// @include()
  sessions  Session[] /// @include()

  otp String?

  @@index([firstName])
  @@index([lastName])
  @@index([middleName])
  @@index([username])
}

model Role {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  name      String    @unique

  /// @include()
  rolePermissions RolePermission[]

  userRoles UserRole[]
}

model Permission {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  scope     String
  resource  String
  operation String

  rolePermissions        RolePermission[]
  accessTokenPermissions AccessTokenPermission[]

  @@unique([scope, resource, operation])
  @@index([scope])
  @@index([resource])
  @@index([operation])
}

model RolePermission {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId Int

  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  permissionId Int

  @@unique([roleId, permissionId])
}

model UserRole {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade) /// @include()
  userId Int

  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade) /// @include() 
  roleId Int

  @@unique([userId, roleId])
}

model Session {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int

  ipAddress String?
  deviceId  String?
  token     String /// @hash(true)
}

model AccessToken {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  name        String  @unique
  description String?

  token String /// @hash(true)

  accessTokenPermissions AccessTokenPermission[] /// @include()
}

model AccessTokenPermission {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  accessToken   AccessToken @relation(fields: [accessTokenId], references: [id])
  accessTokenId Int

  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int
}

model Hook {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  url     String
  payload Json?
  event   String
}

model Audit {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  actorId   String
  resource  String
  operation String
  input     Json
}
