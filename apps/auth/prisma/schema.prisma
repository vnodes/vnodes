generator client {
  provider               = "prisma-client"
  output                 = "../src/app/prisma"
  importFileExtension    = "js"
  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  runtime                = "nodejs"
}

generator prismaService {
  provider = "prisma-service"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @db.Uuid
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  fullName String
  username String @unique ///  @format(email)
  password String /// @hash(true) @format(password)

  isEmailVerified Boolean?

  userRoles UserRole[] /// @include(true)
  sessions  Session[] /// @include(true)

  tags String[]

  otp Otp?

  @@index([username])
}

/// @internal(true)
model Otp {
  id     Int     @id @default(autoincrement())
  value  String? /// @hash(true)
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int     @unique
}

model Role {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  rolePermissions RolePermission[] /// @include(true)
  userRoles       UserRole[]
}

model Permission {
  id Int @id @default(autoincrement())

  scope     String
  resource  String
  operation String

  rolePermissions        RolePermission[]
  accessTokenPermissions AccessTokenPermission[]

  @@unique([scope, resource, operation])
  @@index([scope])
  @@index([resource])
  @@index([operation])
}

model RolePermission {
  id Int @id @default(autoincrement())

  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade) /// @include(true)
  roleId Int

  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade) /// @include(true)
  permissionId Int

  @@unique([roleId, permissionId])
}

model UserRole {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade) /// @include()
  userId Int

  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade) /// @include() 
  roleId Int

  @@unique([userId, roleId])
}

/// @readonly(true)
model Session {
  id         Int       @id @default(autoincrement())
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  lastUsedAt DateTime?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int

  deviceId String?
  ip       String?
  hostname String?
  city     String?
  region   String?
  country  String?
  loc      String?
  org      String?
  postal   String?
  timezone String?
  agent    String?
}

model AccessToken {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  name        String  @unique
  description String?
  token       String /// @hash(true) /// @readonly(true)

  accessTokenPermissions AccessTokenPermission[] /// @include(true)
}

model AccessTokenPermission {
  id Int @id @default(autoincrement())

  accessToken   AccessToken @relation(fields: [accessTokenId], references: [id], onDelete: Cascade) /// @include(true)
  accessTokenId Int

  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade) /// @include(true)
  permissionId Int
}

model Hook {
  id    Int    @id @default(autoincrement())
  url   String
  event String
}

/// @readonly(true)
model Audit {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  status    String
  scope     String
  resource  String
  operation String
  input     Json
  actorId   String

  @@index([actorId])
  @@index([status])
  @@index([resource])
  @@index([operation])
}
